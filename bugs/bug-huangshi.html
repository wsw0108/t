<!DOCTYPE html>
<html>

<head>
  <title>Bug - Huangshi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/maptalks@0.37.0/dist/maptalks.css" />
  <style>
    #map {
      width: 800px;
      height: 600px;
      border: 1px solid #ccc;
    }

  </style>
  <script src="https://cdn.jsdelivr.net/npm/maptalks@0.37.0/dist/maptalks.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/maptalks.mapresty@0.3.0/dist/maptalks.mapresty.js"></script>
</head>

<body>

  <div id="map"></div>

  <script>
    var tileSize = 256;

    var filter = {
      "geometry": {
        "type": "Polygon",
        "coordinates": [
          [
            [115.02053076567248, 30.242786446418705],
            [115.02542978456592, 30.243499243577347],
            [115.02705659520424, 30.247126514711493],
            [115.0278572507855, 30.24987609671737],
            [115.03095492466113, 30.253025000702426],
            [115.03145142842612, 30.254014252464863],
            [115.03881536819681, 30.254365678697667],
            [115.03974582615726, 30.254413252665376],
            [115.04290952611153, 30.25457912891546],
            [115.04446358210178, 30.25466299991038],
            [115.0478281194514, 30.255792295812842],
            [115.05164487124689, 30.257079701479125],
            [115.05277138001146, 30.257771695090305],
            [115.05574671738015, 30.25959971879227],
            [115.05657106985926, 30.260113636985185],
            [115.05942197991783, 30.261890491400397],
            [115.06087603841776, 30.260903319135615],
            [115.06262720546084, 30.26098979514187],
            [115.06260655811518, 30.261193468446958],
            [115.06277716601515, 30.261492407984274],
            [115.06341842758907, 30.262115441549337],
            [115.06550103423798, 30.261675991900752],
            [115.06680369683406, 30.261761502042663],
            [115.06814465167882, 30.260670863657264],
            [115.06966678535558, 30.259430641265975],
            [115.07013691521905, 30.25922496923898],
            [115.07009417887457, 30.25918639910967],
            [115.07015870750315, 30.25909611853733],
            [115.07029372643665, 30.258595199370642],
            [115.07119186606025, 30.25527634565843],
            [115.07132595296063, 30.254972837289507],
            [115.06497796068669, 30.254832343765358],
            [115.06479255969514, 30.250453000923343],
            [115.06646920584639, 30.250462077785066],
            [115.06636125631815, 30.248940093856714],
            [115.06584582539217, 30.24865758723939],
            [115.06583545988238, 30.248019513353107],
            [115.06353065761569, 30.24818528462083],
            [115.06218311807295, 30.246568087498428],
            [115.06078458333631, 30.246459453857057],
            [115.05972678551471, 30.245717244463027],
            [115.05874979643872, 30.245010771340432],
            [115.05619204435729, 30.245283511750422],
            [115.05539097656448, 30.245231804308368],
            [115.05537941998489, 30.24474970475947],
            [115.05612608723418, 30.24386377815195],
            [115.05537753744903, 30.241791860441182],
            [115.05779890740891, 30.239533003939908],
            [115.05681510339687, 30.238376114582394],
            [115.05534966285084, 30.236586971247608],
            [115.0483384574512, 30.232233163584876],
            [115.03898525252596, 30.228343488271978],
            [115.03900116117855, 30.22991618718086],
            [115.03856154964504, 30.231713515501376],
            [115.03774234430573, 30.233390498918567],
            [115.03576752788982, 30.234168387296144],
            [115.03271004428734, 30.234775998755953],
            [115.02982752146794, 30.234951369111393],
            [115.02666108089747, 30.235388397070473],
            [115.0252950712435, 30.235419025702313],
            [115.02222963612405, 30.23525649338751],
            [115.02141607787493, 30.235386010246323],
            [115.01991424428729, 30.23589948376079],
            [115.01919311284043, 30.236255263982574],
            [115.01656506562459, 30.237805324210804],
            [115.01610206260027, 30.237901569502025],
            [115.01531709043998, 30.237809335391102],
            [115.01605433563729, 30.238046098167143],
            [115.01664311990928, 30.238402919062857],
            [115.01717494938937, 30.239266279615038],
            [115.01755323216679, 30.239669309180503],
            [115.01847266649376, 30.24034535194067],
            [115.01871165965306, 30.240712622410726],
            [115.01898805864273, 30.241815011185754],
            [115.01937568510463, 30.24273356959301],
            [115.0198236262328, 30.242863637101063],
            [115.02053076567248, 30.242786446418705]
          ]
        ]
      },
      "relation": 5,
      "crs": {
        "type": "proj4",
        "properties": {
          "proj": "+proj=longlat +datum=BD09"
        }
      }
    };
    var polygon = maptalks.GeoJSON.toGeometry(filter.geometry);
    var center = polygon.getCenter();

    var tileUrl = 'http://online{s}.map.bdimg.com/onlinelabel/?qt=tile&x={x}&y={y}&z={z}&styles=pl&scaler=1&p=1',
      tileAttrib = '&copy; <a href="http://map.baidu.com/">Baidu</a>',
      tileLayer = new maptalks.TileLayer('baidu', {
        urlTemplate: tileUrl,
        subdomains: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9],
        tileSize: [tileSize, tileSize]
      });

    var map = new maptalks.Map('map', {
      spatialReference: {
        projection: 'BAIDU'
      },
      center: center,
      zoom: 14,
      baseLayer: tileLayer,
      attribution: {
        content: tileAttrib
      }
    });

    var layer = new maptalks.VectorLayer('layer');
    layer.addTo(map);

    layer.addGeometry(polygon);

    var query = new maptalks.FeatureQuery({
      host: 'sghvmapp37',
      port: 8000,
      // host: 'localhost',
      // port: 11215,
      mapdb: 'x-sde'
    });
    var options = {
      layer: 'shape_base_prc_city',
      page: 0,
      count: 999999,
      queryFilter: {
        spatialFilter: filter,
        resultCRS: '+proj=longlat +datum=BD09',
        resultFields: ['*']
      }
    };
    query.query(options, (err, collections) => {
      console.log(collections);
    });

  </script>
</body>

</html>
